# 参考手册  
### KLite API参考手册 V3.0
#### 1.功能特性
    KLite是一个基于ARM/Cortex-M微控制器设计的抢占式操作系统内核.
      其设计思想是“简洁易用”, 以降低学习和使用难度为目标.
    --支持优先级抢占
    --支持相同优先级的线程
    --支持线程同步互斥
    --支持动态内存管理
    --支持中断下半部（tasklet）

#### 2.数据类型
    thread_t     线程标识符
    mutex_t      互斥锁标识符
    event_t      事件标识符
    sem_t        信号量标识符
    tasklet_t    小任务标识符
  
#### 3.API参考
##### 3.1 内核相关
-------------------------------------------------------------------------------
    void kernel_init(uint32_t heap_addr, uint32_t heap_size)
    功能: 
        内核初始化.
    参数: 
        addr    内核动态管理内存起始地址
        size    内核动态管理内存大小  
    返回值: 
        无
    备注:
        在调用内核初始化时保证中断处于关闭状态,此函数只能执行一次,
        在初始化内核之前不可调用内核其它函数.
-------------------------------------------------------------------------------
    void kernel_start(void)
    功能: 
        启动内核,内部调用底层函数cpu_os_start,启动滴答定时器.
    参数: 
        无 
    返回值: 
        无
    备注:
        此函数不会返回,所以在调用之前应该创建一个用户线程.
---------------------------------------------------------------------------
    void kernel_timetick(uint32_t time)
    功能:
        内核时间计时
    参数:
        time 计时时间(毫秒)
    返回值:
        无
    备注:
        此函数由滴答时钟中断程序调用, 应用程序不应该调用此函数.
--------------------------------------------------------------------------
    uint32_t kernel_version(void)
    功能:
        返回KLite内核的版本号
    参数:
        无
    返回值:
        版本号,BIT[31:24]主版本号,BIT[23:16]次版本号,BIT[15:0]修订号
------------------------------------------------------------------------------- 
    uint32_t kernel_time(void)
    功能:
        返回内核从启动到现在所经历的时间(毫秒).
    参数:
        无
    返回值:
        系统时间(毫秒)
-------------------------------------------------------------------------------
    uint32_t kernel_idletime(void)
    功能:
        返回内核自启动以来到现在的空闲时间(毫秒).
    参数:
        无
    返回值:
        空闲时间(毫秒)


##### 3.2 内存管理
-------------------------------------------------------------------------------
    void* heap_alloc(uint32_t size)
    功能:
        向内核申请一段连续内存,功能和malloc一样
    参数:
        size    要申请的内存大小
    返回值:
        申请成功返回内存指针
        申请失败返回NULL
    备注:
        使用heap_alloc申请的内存,在使用完毕后,请使用heap_free释放内存.
        
-------------------------------------------------------------------------------
    void heap_free(void *mem)
    功能:
        释放由heap_malloc申请的内存,功能和free一样
    参数:
        mem     由heap_alloc申请的内存指针
    返回值:
        无
    备注:
        使用heap_alloc申请的内存,在使用完毕后,请使用heap_free释放内存. 
-------------------------------------------------------------------------------
    void heap_usage(uint32_t *total, uint32_t *used)
    功能:
        获取内存用量信息
    参数:
        used    输出已使用的内存数量(字节)
        total   输出总内存数量(字节)
    返回值:
        无
    备注:
        可使用此函数关注系统内存消耗,以适当调整内存分配.

##### 3.3 线程管理
-------------------------------------------------------------------------------
        thread_t thread_create(void(*entry)(void*), void *arg, uint32_t stack_size)
    功能:
        创建一个新的线程,并加入就绪队列
    参数:
        entry      线程入口函数
        arg        线程入口函数的参数
        stack_size 线程拥有的栈空间大小,如果该值为0则使用系统默认的栈大小
    返回值:
        成功返回线程标识符
        失败返回NULL
    备注:
        内核自动为新线程分配内存空间和栈空间,如果栈设置太小容易在运行过程中产
        生栈溢出错误,如果设置太大可能会由于系统内存不足而创建失败.
-------------------------------------------------------------------------------
    void thread_delete(thread_t thread)
    功能:
        结束一个线程,并释放内存
    参数:
        thread  要结束的线程标识符
    返回值:
        无
    备注:
        该函数会直接停止线程运行,并释放线程所占用的内存.
        该函数不能用来结束当前线程.
        如果想要结束当前线程请使用thread_exit()或直接使用return.
-------------------------------------------------------------------------------
    void thread_setprio(thread_t thread, int prio)
    功能:
        设置线程优先级
    参数:
        thread      线程标识符
        prio        新的优先级
                    最低优先级为THREAD_PRIORITY_MIN
                    最高优先级为THREAD_PRIORITY_MAX
    返回值:
        无
    备注:
        线程优先级决定线程调度顺序,越高的优先级具有越高的实时性,线程默认优先级为0
-------------------------------------------------------------------------------
    int thread_getprio(thread_t thread)
    功能:
        获取线程当前优先级
    参数:
        thread  线程标识符
    返回值:
        该线程当前的优先级
-------------------------------------------------------------------------------
    thread_t thread_self(void)
    功能:
        获取当前线程标识符
    参数:
        无
    返回值:
        当前线程的标识符
-------------------------------------------------------------------------------
    void thread_sleep(uint32_t time)
    功能:
        将当前线程休眠一段时间,释放CPU控制权
    参数:
        time    休眠时间(毫秒)
    返回值:
        无
-------------------------------------------------------------------------------
    void thread_exit(void)
    功能:
        自己结束当前线程，并释放资源
    参数:
        无
    返回值:
        无
-------------------------------------------------------------------------------
    原型:
        void thread_suspend(thread_t thread)
    功能:
        挂起指定线程
    参数:
        thread  线程标识符
    返回值:
        无
    备注:
        不能用来挂起当前线程.
-------------------------------------------------------------------------------
    void thread_resume(thread_t thread)
    功能:
        恢复被挂起的线程
    参数:
        thread  线程标识符
    返回值:
        无
    备注:
        只能用来恢复被thread_suspend函数挂起的线程.
-------------------------------------------------------------------------------
    uint32_t thread_time(thread_t thread)
    功能:
        获取线程自启动以来所占用CPU的节拍数.
    参数:
        thread  线程标识符
    返回值:
        线程运行的节拍数
    备注:
        可以使用此函数来监控线程的CPU占用率
-------------------------------------------------------------------------------

##### 3.4 互斥锁
-------------------------------------------------------------------------------
    mutex_t mutex_create(void)
    功能:
        创建一个新的互斥锁
    参数:
        无
    返回值:
        成功返回互斥锁标识符
        失败返回NULL
-------------------------------------------------------------------------------
    void mutex_lock(mutex_t mutex)
    功能:
        将mutex指定的互斥锁标记为锁定状态
    参数:
        mutex   互斥锁标识符
    返回值:
        无
    备注:
        如果mutex指向的互斥锁已被其它线程锁定,则调用线程将会被阻塞,直到另一个线程
        释放这个互斥锁.
-------------------------------------------------------------------------------
    void mutex_unlock(mutex_t mutex)
    功能:
        释放由参数mutex指定的互斥锁
    参数:
        mutex   互斥锁标识符
    返回值:
        无
    备注:
        mutex_lock和mutex_unlock必须成对出现.
-------------------------------------------------------------------------------
    void mutex_delete(mutex_t mutex)
    功能:
        删除一个互斥锁,释放内存
    参数:
        mutex   被删除的互斥锁标识符
    返回值:
        无
    备注:
        在删除互斥锁的时候不会检查是否有线程拥有这个互斥锁.
        因此在删除之前请确认没有线程在使用.
-------------------------------------------------------------------------------


##### 3.5 信号量
-------------------------------------------------------------------------------
    sem_t sem_create(uint32_t init_value, uint32_t max_value)
    功能:
        创建一个新的信号量.
    参数:
        init_value   信号量初始值.
        max_value    信号量最大值.
    返回值:
        创建成功返回信号量标识符.
        创建失败返回NULL.
    备注:
        无.
-------------------------------------------------------------------------------
    void sem_wait(sem_t sem)
    功能:
        等待该信号量为一个非零值,然后将信号量的值减去1.
    参数:
        sem     信号量标识符.
    返回值:
        无
    备注:
        如果信号量的计数值为零,则当前线程会被阻塞.
-------------------------------------------------------------------------------
    bool sem_timedwait(sem_t sem, uint32_t timeout)
    功能:
        超时等待该信号量为一个非零值,如果未超时则将信号量的值减去1.
    参数:
        sem     信号量标识符.
        timeout 等待超时时间，单位为滴答节拍数
    返回值:
        等待成功返回true.
        等待超时返回false.
    备注:
        如果信号量的计数值为零,则当前线程会被阻塞一段时间.
-------------------------------------------------------------------------------
    void sem_post(sem_t sem)
    功能:
        给信号量的值加一.
    参数:
        sem     信号量标识符.
    返回值:
        无.
    备注:
        如果信号计数值达到最大值,则不会加1.
-------------------------------------------------------------------------------
    uint32_t sem_getvalue(sem_t sem)
    功能:
        返回信号量的计数值.
    参数:
        sem     信号量标识符.
    返回值:
        计数值.
    备注:
        该函数在返回时,可能内部计数值已经发生改变.
-------------------------------------------------------------------------------
    void sem_delete(sem_t sem)
    功能:
        删除信号量对象,并释放内存.
    参数:
        sem     信号量标识符.
    返回值:
        无.
    备注:
        在没有线程使用它时才能删除,否则可能产生错误.
-------------------------------------------------------------------------------

##### 3.6 事件
-------------------------------------------------------------------------------
    event_t event_create(bool state, bool manual)
    功能:
        创建一个新的事件对象.
    参数:
        state   初始状态,false表示无效,true表示有效.
        manual  手动模式,true表示手动复位模式,false表示自动复位模式
    返回值:
        创建成功返回事件标识符.
        创建失败返回NULL.
    备注:
        1.手动复位模式,当调用event_set之后,事件会保持有效状态,所有正在等待事件
          的线程都会被唤醒,直到再次调用event_reset才能将事件置为无效状态.
        2.自动复位模式,当调用event_set之后,所有正在等待这个事件的线程都会被唤醒,
          然后事件会自动复位,变为无效状态;如果此时没有线程在等待事件,那么事件
          会保持有效状态,直到有线程调用event_wait/event_timedwait之后自动复位
-------------------------------------------------------------------------------
    void event_wait(event_t event)
    功能:
        等待事件.
    参数:
        event   事件标识符.
    返回值:
        无.
    备注:
        无.
-------------------------------------------------------------------------------
    bool event_timedwait(event_t event, uint32_t timeout)
    功能:
        定时等待事件.
    参数:
        event   事件标识符.
        timeout 等待超时时间，单位为滴答节拍数.
    返回值:
        等待成功返回true.
        等待超时返回false.
    备注:
        无.
-------------------------------------------------------------------------------
    void event_set(event_t event)
    功能:
        标记事件为有效状态.
    参数:
        event   事件标识符.
    返回值:
        无.
    备注:
        参考event_create中的描述
-------------------------------------------------------------------------------
    void event_reset(event_t event)
    功能:
        标记事件为无效状态.
    参数:
        event   事件标识符.
    返回值:
        无.
    备注:
        调用此函数之后,事件会被标记为无效状态,直到再次调用event_set.
-------------------------------------------------------------------------------
    void event_delete(event_t event)
    功能:
        删除事件对象,并释放内存.
    参数:
        event   事件标识符.
    返回值:
        无.
    备注:
        在没有线程使用它时才能删除,否则可能产生错误.
-------------------------------------------------------------------------------

##### 3.7 小任务(中断下半部)
-------------------------------------------------------------------------------
    void tasklet_init(uint32_t stack_size)
    功能:
        初始化tasklet功能
    参数:
        stack_size  tasklet堆栈大小
    返回:
        无
    备注:
        若不需要tasklet功能,可以不用调用此函数.如果要初始化应该在kernel_init的后面.
        tasklet小任务机制专门用于实现中断下半部,在中断中调用tasklet_schedule.
        在硬件中断处理程序中不能调用任何线程通信相关的函数.
        tasklet任务不能调用阻塞,休眠,挂起函数.
        tasklet任务函数的优先级比硬件中断低,比所有用户线程优先级高.
------------------------------------------------------------------------------
    tasklet_t tasklet_create(void (*func)(void), void *data)
    功能:
        创建一个小任务
    参数:
        func   tasklet任务函数.
        data   传递给任务函数的参数
    返回值:
        无.
    备注:
        无.
-------------------------------------------------------------------------------
    void tasklet_delete(tasklet_t tasklet)
    功能:
        删除指定的小任务
    参数:
        tasklet  要删除的小任务标识
    返回:
        无
    备注:
        无
-------------------------------------------------------------------------------
    void tasklet_schedule(tasklet_t tasklet)
    功能:
        执行指定的小任务
    参数:
        tasklet  要执行的小任务标识
    返回:
        无
    备注:
        此函数一般在硬件中断函数中调用.

#### 4 其它
下载地址: www.oschina.net/p/KLite
  
